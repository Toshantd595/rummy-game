<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rummy Multiplayer</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #1a1a2e;
      color: white;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    h1 {
      color: #facc15;
      text-align: center;
      padding: 10px;
    }
    input, select, button {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
    }
    button {
      background: #facc15;
      color: black;
      cursor: pointer;
    }
    .card-img {
      width: 60px;
      height: 90px;
      margin: 2px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .card-img:hover {
      transform: scale(1.1);
    }
    .meld-selected {
      outline: 3px solid #66ffcc;
      transform: scale(1.1);
    }
    .cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 10px 0;
    }
    .melded-cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      padding: 8px;
      background: #263159;
      border-radius: 6px;
    }
    .chat-box {
      text-align: center;
      margin: 10px auto;
      display: none;
    }
    .chat-bubble {
      background: #fef08a;
      color: #000;
      padding: 8px 12px;
      border-radius: 10px;
      margin: 5px auto;
      display: inline-block;
      animation: fadeout 3s forwards;
    }
    @keyframes fadeout {
      0% { opacity: 1; }
      70% { opacity: 1; }
      100% { opacity: 0; display: none; }
    }
  </style>
</head>
<body>
<h1>Rummy Multiplayer</h1>
<div id="lobby" style="text-align:center">
  <div>
    <button onclick="createGame()">Create Game</button>
    <input type="text" id="gameCodeInput" placeholder="Enter Game Code" maxlength="6">
    <button onclick="joinGame()">Join</button>
  </div>
  <div>
    <input id="playerName" placeholder="Your name">
    <select id="avatarSelect">
      <option value="warrior">Avatar 1</option>
      <option value="queen">Avatar 2</option>
      <option value="wizard">Avatar 3</option>
      <option value="ninja">Avatar 4</option>
    </select>
  </div>
  <div id="gameCodeDisplay"></div>
  <div id="startGameContainer" style="display:none">
    <button onclick="startGame()">Start Game</button>
  </div>
</div>

<div id="game" style="display:none">
  <div class="table">
    <div class="info-bar" id="turnInfo"></div>

    <div class="controls" id="controls" style="display:none; justify-content:center; gap:10px;">
      <button onclick="drawCard()">Draw Card</button>
      <button onclick="sortHand()">Sort Hand</button>
      <button onclick="meld()">Meld</button>
      <button onclick="declareVictory(playerName)">Declare Win</button>
      <button onclick="resetGame()" id="startNewGameBtn" style="display:none;">üîÑ Start New Game</button>
    </div>

    <div style="margin-top:10px; text-align:center;">
      <span>Top Discard: <img id="topDiscardImg" src="https://deckofcardsapi.com/static/img/back.png" width="60" /></span>
    </div>

    <div id="handTitle" style="text-align:center; margin-top:15px;">Your Hand</div>
    <div class="cards" id="hand"></div>

    <h3 id="meldTitle" style="margin:10px; display:none;">Melded Cards</h3>
    <div id="meldedArea" class="melded-cards" style="display:none;"></div>

    <div class="chat-box" id="chatBox">
      <input type="text" id="chatInput" placeholder="Say something..." onkeydown="if(event.key==='Enter') sendChat()">
      <button onclick="sendChat()">Speak</button>
      <div>
        <button onclick="sendQuick('Hi queen of cards üëë')">Hi queen of cards üëë</button>
        <button onclick="sendQuick('Nice move, love üòâ')">Nice move, love üòâ</button>
        <button onclick="sendQuick('Feeling lucky?')">Feeling lucky?</button>
        <button onclick="sendQuick('Don‚Äôt bluff me üòè')">Don‚Äôt bluff me üòè</button>
      </div>
      <div id="chatArea"></div>
    </div>
  </div>
</div>
<script>
// ‚úÖ Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyC1D45vfziD-wqIrDGANAY7GzR0L94BqB8",
  authDomain: "rummy-multiplayer-fe391.firebaseapp.com",
  databaseURL: "https://rummy-multiplayer-fe391-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "rummy-multiplayer-fe391",
  storageBucket: "rummy-multiplayer-fe391.appspot.com",
  messagingSenderId: "717212591323",
  appId: "1:717212591323:web:7cb38b16733f7a9b5498fe"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let gameCode = "";
let playerId = "";
let playerName = "";
let hasDrawn = false;
let selectedCards = [];
let newDrawnCard = null;

function getCardImage(card) {
  const [rank, , suit] = card.split(" ");
  const rankMap = { A: "A", J: "J", Q: "Q", K: "K" };
  const suitMap = { Spades: "S", Hearts: "H", Diamonds: "D", Clubs: "C" };
  const r = rankMap[rank] || rank;
  const s = suitMap[suit];
  return `https://deckofcardsapi.com/static/img/${r}${s}.png`;
}

function createGame() {
  gameCode = Math.random().toString(36).substr(2, 6).toUpperCase();
  db.ref(`games/${gameCode}`).set({ status: "lobby" });
  document.getElementById("gameCodeDisplay").innerText = `Game Code: ${gameCode}`;
}

function joinGame() {
  const inputCode = document.getElementById("gameCodeInput").value.trim().toUpperCase();
  if (!inputCode) return alert("Enter Game Code");
  gameCode = inputCode;

  playerName = document.getElementById("playerName").value.trim();
  if (!playerName) return alert("Enter your name");

  const avatar = document.getElementById("avatarSelect").value;

  db.ref(`games/${gameCode}`).once("value").then(gameSnap => {
    const game = gameSnap.val();
    if (!game) return alert("Game not found!");

    const players = game.players || {};
    if (Object.keys(players).length >= 4) return alert("Maximum 4 players allowed");

    const usedIds = Object.keys(players);
    const nextId = usedIds.includes("player1") ? 
                   (usedIds.includes("player2") ? 
                    (usedIds.includes("player3") ? "player4" : "player3") 
                    : "player2") 
                   : "player1";

    playerId = nextId;

    db.ref(`games/${gameCode}/players/${nextId}`).set({
      name: playerName,
      avatar: avatar,
      hand: []
    }).then(() => {
      document.getElementById("lobby").style.display = "none";
      document.getElementById("game").style.display = "block";
      listen();

db.ref(`games/${gameCode}/players`).on("value", snap => {
  const playerList = snap.val() || {};
  if (Object.keys(playerList).length >= 2 && playerId === "player1") {
    document.getElementById("startGameContainer").style.display = "block";
        }
      });
    });
  });
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function startGame() {
  const suits = ["Spades", "Hearts", "Diamonds", "Clubs"];
  const ranks = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
  let deck = [];
  for (let s of suits) {
    for (let r of ranks) {
      deck.push(`${r} of ${s}`);
    }
  }
  deck = shuffle(deck);

  db.ref(`games/${gameCode}/players`).once("value").then(playerSnap => {
    const players = playerSnap.val();
    const ids = Object.keys(players);
    ids.forEach(pid => {
      const hand = deck.splice(0, 13);
      db.ref(`games/${gameCode}/players/${pid}/hand`).set(hand);
    });
    db.ref(`games/${gameCode}/deck`).set(deck);
    db.ref(`games/${gameCode}/discard`).set(deck.pop());
    db.ref(`games/${gameCode}/turn`).set("player1");
    db.ref(`games/${gameCode}/status`).set("started");
    document.getElementById("startGameContainer").style.display = "none";
  });
}

function drawCard() {
  db.ref(`games/${gameCode}/turn`).once("value").then(turnSnap => {
    if (turnSnap.val() !== playerId) return alert("Not your turn!");
    db.ref(`games/${gameCode}/deck`).once("value").then(deckSnap => {
      let deck = deckSnap.val();
      if (!deck || deck.length === 0) return alert("Deck is empty");
      const card = deck.pop();
      newDrawnCard = card;
      db.ref(`games/${gameCode}/deck`).set(deck);
      db.ref(`games/${gameCode}/players/${playerId}/hand`).once("value").then(handSnap => {
        let hand = handSnap.val() || [];
        hand.push(card);
        db.ref(`games/${gameCode}/players/${playerId}/hand`).set(hand);
        hasDrawn = true;
      });
    });
  });
}

function sortHand() {
  db.ref(`games/${gameCode}/players/${playerId}/hand`).once("value").then(snap => {
    let hand = snap.val() || [];
    const rankOrder = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    hand.sort((a, b) => {
      const [rankA, , suitA] = a.split(" ");
      const [rankB, , suitB] = b.split(" ");
      const suitSort = suitA.localeCompare(suitB);
      return suitSort !== 0 ? suitSort : rankOrder.indexOf(rankA) - rankOrder.indexOf(rankB);
    });
    db.ref(`games/${gameCode}/players/${playerId}/hand`).set(hand);
  });
}

// ‚úÖ Remaining JavaScript Logic
function renderHand(hand) {
  const div = document.getElementById("hand");
  div.innerHTML = "";
  hand.forEach(c => {
    const img = document.createElement("img");
    img.className = "card-img";
    img.src = getCardImage(c);
    if (selectedCards.includes(c)) img.classList.add("meld-selected");
    if (newDrawnCard === c) img.classList.add("new-card");
    img.onclick = () => {
      if (hasDrawn) {
        const index = hand.indexOf(c);
        discard(index);
      } else {
        toggleSelect(c);
      }
    };
    div.appendChild(img);
  });
}

function toggleSelect(card) {
  if (selectedCards.includes(card)) {
    selectedCards = selectedCards.filter(c => c !== card);
  } else {
    selectedCards.push(card);
  }
  db.ref(`games/${gameCode}/players/${playerId}/hand`).once("value").then(snap => {
    renderHand(snap.val());
  });
}

function discard(index) {
  if (!hasDrawn) return alert("You must draw a card before discarding.");
  db.ref(`games/${gameCode}/players/${playerId}/hand`).once("value").then(h => {
    let hand = h.val() || [];
    const card = hand.splice(index, 1)[0];
    db.ref(`games/${gameCode}/players/${playerId}/hand`).set(hand);
    db.ref(`games/${gameCode}/discard`).set(card);

    db.ref(`games/${gameCode}/players`).once("value").then(p => {
      const ids = Object.keys(p.val());
      const next = ids[(ids.indexOf(playerId) + 1) % ids.length];
      db.ref(`games/${gameCode}/turn`).set(next);
    });

    hasDrawn = false;
    selectedCards = [];
    newDrawnCard = null;
  });
}

function meld() {
  if (selectedCards.length < 3) return alert("Select 3+ cards");
  const suits = selectedCards.map(c => c.split(" ")[2]);
  const ranks = selectedCards.map(c => c.split(" ")[0]);
  const allSameRank = ranks.every(r => r === ranks[0]);
  const allSameSuit = suits.every(s => s === suits[0]);
  const rankOrder = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  const sorted = selectedCards.map(c => ({ c, i: rankOrder.indexOf(c.split(" ")[0]) }))
                              .sort((a, b) => a.i - b.i);

  let isRun = allSameSuit && sorted.every((v, i, arr) => i === 0 || v.i === arr[i - 1].i + 1);
  let isSet = allSameRank && new Set(suits).size === selectedCards.length;

  if (isRun || isSet) {
    showMeld(selectedCards);
    db.ref(`games/${gameCode}/players/${playerId}/melds`).push(selectedCards);
    db.ref(`games/${gameCode}/players/${playerId}/hand`).once("value").then(hSnap => {
      const remaining = hSnap.val().filter(c => !selectedCards.includes(c));
      db.ref(`games/${gameCode}/players/${playerId}/hand`).set(remaining);
    });
    alert("‚úÖ Valid Meld! Now you may Declare if you've used all your cards.");
    newDrawnCard = null;
    selectedCards = [];
  } else {
    alert("‚ùå Invalid Meld");
  }
}

function showMeld(cards) {
  const area = document.getElementById("meldedArea");
  const title = document.getElementById("meldTitle");
  area.innerHTML = "";
  if (cards.length) {
    title.style.display = "block";
    area.style.display = "flex";
  }
  cards.forEach(c => {
    const img = document.createElement("img");
    img.src = getCardImage(c);
    img.className = "card-img";
    area.appendChild(img);
  });
}

function declareVictory(name) {
  db.ref(`games/${gameCode}/players/${playerId}/hand`).once("value").then(snap => {
    const hand = snap.val() || [];
    if (hand.length > 0) return alert("‚ùå You must use all your cards before declaring victory.");
    db.ref(`games/${gameCode}/status`).set("ended");
    db.ref(`games/${gameCode}/winner`).set({ name, score: 100 });
  });
}

function resetGame() {
  if (!confirm("Start a new game?")) return;
  db.ref(`games/${gameCode}`).remove().then(() => location.reload());
}

function listen() {
  db.ref(`games/${gameCode}/status`).on("value", s => {
    const status = s.val();
    if (status === "started") {
      document.getElementById("controls").style.display = "flex";
      document.getElementById("chatBox").style.display = "block";
    } else if (status === "ended") {
      document.getElementById("controls").style.display = "none";
    }
  });

  db.ref(`games/${gameCode}/players/${playerId}/hand`).on("value", s => {
    const hand = s.val() || [];
    renderHand(hand);
  });

  db.ref(`games/${gameCode}/discard`).on("value", snap => {
    const val = snap.val();
    const img = document.getElementById("topDiscardImg");
    img.src = val && val !== "None" ? getCardImage(val) : "https://deckofcardsapi.com/static/img/back.png";
  });

  db.ref(`games/${gameCode}/turn`).on("value", s => {
    const val = s.val();
    const turnDiv = document.getElementById("turnInfo");
    if (!val) return;
    db.ref(`games/${gameCode}/players/${val}/name`).once("value").then(n => {
      if (val === playerId) {
        turnDiv.innerText = "üü° Your Turn";
      } else {
        turnDiv.innerText = `‚è≥ ${n.val()}'s Turn`;
      }
    });
  });

  db.ref(`games/${gameCode}/winner`).on("value", snap => {
    const winner = snap.val();
    if (winner && winner.name) {
      document.getElementById("turnInfo").innerText = `üéâ ${winner.name} wins the game! üéâ`;
      if (playerId === "player1") {
        document.getElementById("startNewGameBtn").style.display = "inline-block";
      }
    }
  });

  db.ref(`games/${gameCode}/chat`).on("child_added", snap => {
    const msg = snap.val();
    const bubble = document.createElement("div");
    bubble.className = "chat-bubble";
    bubble.innerText = msg;
    document.getElementById("chatArea").appendChild(bubble);
  });
}

function sendChat() {
  const msg = document.getElementById("chatInput").value.trim();
  if (!msg) return;
  db.ref(`games/${gameCode}/chat`).push(`${playerName}: ${msg}`);
  document.getElementById("chatInput").value = "";
}

function sendQuick(msg) {
  db.ref(`games/${gameCode}/chat`).push(`${playerName}: ${msg}`);
}
</script>
</script>
</body>
</html>
