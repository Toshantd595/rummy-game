<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Love Rummy</title>
  <meta name="description" content="Multiplayer Rummy Game with Love Theme" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    Babel.registerPreset("react", {
      presets: [Babel.availablePresets["react"]],
    });
  </script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            rose: { 500: "#f43f5e", 700: "#be123c" },
            pink: { 500: "#ec4899", 600: "#db2777" },
          },
          animation: {
            pulseHeart: "pulse 2s infinite",
          },
        },
      },
    };
  </script>

  <style>
    body {
      background: linear-gradient(to bottom right, #fdf2f8, #fce7f3, #fbcfe8);
      font-family: 'Segoe UI', sans-serif;
    }
    .love-gradient {
      background: linear-gradient(to right, #f472b6, #fb7185, #f472b6);
    }
    .card {
      width: 40px;
      height: 60px;
      border-radius: 6px;
      text-align: center;
      padding-top: 12px;
      font-size: 18px;
      font-weight: bold;
      background-color: white;
      border: 2px solid #fb7185;
      margin: 2px;
      box-shadow: 1px 1px 4px rgba(0,0,0,0.2);
    }
    .selected {
      transform: translateY(-10px);
      border-color: #db2777;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="react">
    const { useState, useEffect } = React;

    const firebaseConfig = {
      apiKey: "AIzaSyC1D45vfziD-wqIrDGANAY7GzR0L94BqB8",
      authDomain: "rummy-multiplayer-fe391.firebaseapp.com",
      databaseURL: "https://rummy-multiplayer-fe391-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "rummy-multiplayer-fe391",
      storageBucket: "rummy-multiplayer-fe391.appspot.com",
      messagingSenderId: "717212591323",
      appId: "1:717212591323:web:7cb38b16733f7a9b5498fe"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function generateDeck() {
      const suits = ["â™ ", "â™¥", "â™¦", "â™£"];
      const values = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];
      const deck = [];
      for (let suit of suits) {
        for (let value of values) {
          deck.push(value + suit);
        }
      }
      return deck.sort(() => Math.random() - 0.5);
    }

    function isValidMeld(cards) {
      // Example: sequence check for same suit
      if (cards.length < 3) return false;
      const suits = cards.map(c => c.slice(-1));
      const values = cards.map(c => c.slice(0, -1));
      const allSameSuit = suits.every(s => s === suits[0]);
      const valueMap = {A:1, J:11, Q:12, K:13};
      const nums = values.map(v => valueMap[v] || parseInt(v)).sort((a,b)=>a-b);
      const isSequence = nums.every((n, i) => i === 0 || n === nums[i-1] + 1);
      return allSameSuit && isSequence;
    }

    function App() {
      const [room, setRoom] = useState(null);
      const [playerId, setPlayerId] = useState(null);
      const [players, setPlayers] = useState([]);
      const [hand, setHand] = useState([]);
      const [selected, setSelected] = useState([]);
      const [turn, setTurn] = useState(null);
      const [message, setMessage] = useState("");





      
      function drawCard() {
        if (turn !== playerId) return;
        const deckRef = db.ref(`rooms/${room}/deck`);
        deckRef.once("value", snap => {
          const deck = snap.val() || [];
          const drawn = deck.pop();
          setHand(prev => [...prev, drawn]);
          deckRef.set(deck);
        });
      }

      function discardCard(card) {
        if (turn !== playerId) return;
        setHand(prev => prev.filter(c => c !== card));
        db.ref(`rooms/${room}/discard`).set(card);
        db.ref(`rooms/${room}/turn`).set(players.find(p => p !== playerId));
      }

      function meld() {
        if (isValidMeld(selected)) {
          setMessage("âœ… Valid meld!");
          setSelected([]);
        } else {
          setMessage("âŒ Invalid meld!");
        }
      }

      function declareWin() {
        if (hand.length === 0) {
          db.ref(`rooms/${room}/winner`).set(playerId);
        } else {
          setMessage("âŒ Meld all cards first!");
        }
      }

      function resetGame() {
        const newDeck = generateDeck();
        const split = Math.floor(newDeck.length / 2);
        const hands = {
          player1: newDeck.slice(0, 13),
          player2: newDeck.slice(13, 26),
        };
        db.ref(`rooms/${room}`).set({
          deck: newDeck.slice(26),
          players: players,
          turn: players[0],
          hands,
          discard: null,
          winner: null,
        });
      }

      useEffect(() => {
        const hash = window.location.hash.slice(1);
        if (!hash) return;
        setRoom(hash);
        const id = Math.random().toString(36).slice(2, 7);
        setPlayerId(id);
        const playerRef = db.ref(`rooms/${hash}/players`);
        playerRef.once("value", snap => {
          const existing = snap.val() || [];
          if (!existing.includes(id)) {
            playerRef.set([...existing, id]);
          }
          setPlayers([...existing, id]);
        });
        db.ref(`rooms/${hash}/hands/${id}`).on("value", snap => {
          if (snap.exists()) setHand(snap.val());
        });
        db.ref(`rooms/${hash}/turn`).on("value", snap => {
          if (snap.exists()) setTurn(snap.val());
        });
      }, []);

      return (
        <div className="p-4 text-center">
          <h1 className="text-3xl font-bold love-gradient text-transparent bg-clip-text mb-4">ðŸ’– Love Rummy</h1>
          {!room && (
            <button
              onClick={() => {
                const newRoom = Math.random().toString(36).substr(2, 6).toUpperCase();
                setRoom(newRoom);
                window.location.hash = newRoom;
                resetGame();
              }}
              className="bg-pink-500 text-white px-6 py-3 rounded-lg shadow"
            >
              Create Room
            </button>
          )}
          {room && (
            <>
              <h2 className="text-lg text-pink-700">Room: {room}</h2>
              <h3 className="mb-2 text-rose-500">{turn === playerId ? "ðŸŽ¯ Your Turn" : "Waiting..."}</h3>
              <div className="flex flex-wrap justify-center mb-4">
                {hand.map(card => (
                  <div
                    key={card}
                    className={`card ${selected.includes(card) ? "selected" : ""}`}
                    onClick={() =>
                      setSelected(prev =>
                        prev.includes(card)
                          ? prev.filter(c => c !== card)
                          : [...prev, card]
                      )
                    }
                  >
                    {card}
                  </div>
                ))}
              </div>
              <div className="flex flex-wrap justify-center gap-2">
                <button onClick={drawCard} className="bg-purple-500 text-white px-4 py-2 rounded">
                  Draw
                </button>
                <button onClick={() => discardCard(selected[0])} className="bg-rose-500 text-white px-4 py-2 rounded">
                  Discard
                </button>
                <button onClick={meld} className="bg-yellow-500 text-white px-4 py-2 rounded">
                  Meld
                </button>
                <button onClick={declareWin} className="bg-green-500 text-white px-4 py-2 rounded">
                  Declare
                </button>
                <button onClick={resetGame} className="bg-gray-400 text-white px-4 py-2 rounded">
                  Restart
                </button>
              </div>
              <p className="mt-4 text-pink-600">{message}</p>
            </>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
