<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rummy Multiplayer</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #1a1a2e;
      color: white;
      margin: 0;
      padding: 0;
    }
    h1 {
      color: #facc15;
      text-align: center;
      padding: 10px;
    }
    input, select, button, textarea {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
    }
    button {
      background: #facc15;
      color: black;
      cursor: pointer;
    }
    .card-img {
      width: 60px;
      height: 90px;
      margin: 2px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .card-img:hover {
      transform: scale(1.1);
    }
    .cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 10px 0;
    }
    .table {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 10px;
    }
    .opponent-area, .your-area {
      text-align: center;
    }
    .info-bar {
      background: #facc15;
      color: #000;
      padding: 8px 12px;
      border-radius: 10px;
      margin: 10px auto;
      display: inline-block;
    }
    .chat-box {
      background: #333;
      padding: 10px;
      border-radius: 5px;
      margin: 10px auto;
      width: 90%;
      max-width: 500px;
      display: none;
      text-align: center;
    }
    .chat-bubble {
      background: #fef08a;
      color: #000;
      padding: 8px 12px;
      border-radius: 10px;
      margin: 5px auto;
      display: inline-block;
    }
    .controls {
      display: none;
      margin: 10px auto;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    #handTitle {
      font-weight: bold;
      margin-top: 10px;
    }
    .quick-chat {
      margin-top: 10px;
    }
    .quick-chat button {
      background: #444;
      color: #facc15;
      margin: 3px;
    }
    @media (max-width: 600px) {
      .card-img {
        width: 45px;
        height: 65px;
      }
      button, input, select, textarea {
        font-size: 14px;
        padding: 8px;
      }
    }
  </style>
</head>
<body>
<h1>Rummy Multiplayer</h1>
<div id="lobby" style="text-align:center">
  <div>
    <button onclick="createGame()">Create Game</button>
    <input type="text" id="gameCodeInput" placeholder="Enter Game Code" maxlength="6">
    <button onclick="joinGame()">Join</button>
  </div>
  <div>
    <input id="playerName" placeholder="Your name">
    <select id="avatarSelect">
      <option value="toshant">Avatar 1</option>
      <option value="aastha">Avatar 2</option>
      <option value="jack">Avatar 3</option>
      <option value="jill">Avatar 4</option>
    </select>
  </div>
  <div id="gameCodeDisplay"></div>
</div>

<div id="game" style="display:none">
  <div class="table">
    <div class="opponent-area" id="opponentArea"></div>
    <div class="info-bar" id="turnInfo"></div>
    <div class="controls" id="controls">
      <button onclick="drawCard()">Draw Card</button>
      <button onclick="sortHand()">Sort Hand</button>
      <button onclick="meld()">Meld / Lay Off</button>
      <button onclick="resetGame()" id="resetBtn" style="display:none">Reset Game</button>
    </div>
    <div class="info-bar">
      Deck Size: <span id="deckSize">0</span> | Top Discard: <span id="topDiscard">None</span>
    </div>
    <div id="handTitle">Your Hand</div>
    <div class="cards" id="hand"></div>
    <div class="your-area" id="yourAvatar"></div>
    <button id="startBtn" onclick="startGame()" style="display:none; margin-top:10px">Start Game</button>
    <div class="chat-box" id="chatBox">
      <input type="text" id="chatInput" placeholder="Say something..." onkeydown="if(event.key==='Enter') sendChat()">
      <button onclick="sendChat()">Speak</button>
      <div class="quick-chat">
        <button onclick="sendQuick('Hi queen of cards üëë')">Hi queen of cards üëë</button>
        <button onclick="sendQuick('Nice move, love üòâ')">Nice move, love üòâ</button>
        <button onclick="sendQuick('Feeling lucky?')">Feeling lucky?</button>
        <button onclick="sendQuick('Don‚Äôt bluff me üòè')">Don‚Äôt bluff me üòè</button>
        <button onclick="sendQuick('You‚Äôre going down üÉè')">You‚Äôre going down üÉè</button>
      </div>
      <div id="chatArea"></div>
    </div>
  </div>
</div>

<script>
// üî• Firebase Config
const config = {
  apiKey: "AIzaSyC1D45vfziD-wqIrDGANAY7GzR0L94BqB8",
  authDomain: "rummy-multiplayer-fe391.firebaseapp.com",
  databaseURL: "https://rummy-multiplayer-fe391-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "rummy-multiplayer-fe391",
  storageBucket: "rummy-multiplayer-fe391.appspot.com",
  messagingSenderId: "717212591323",
  appId: "1:717212591323:web:7cb38b16733f7a9b5498fe"
};
firebase.initializeApp(config);
const db = firebase.database();

let gameCode = "";
let playerId = "";
let playerName = "";
let avatar = "";
let hasDrawn = false;

function generateCode() {
  return Math.random().toString(36).substring(2, 8).toUpperCase();
}

function createGame() {
  gameCode = generateCode();
  document.getElementById("gameCodeDisplay").innerText = `Game Code: ${gameCode}`;
}

function joinGame() {
  gameCode = document.getElementById("gameCodeInput").value.trim().toUpperCase() || gameCode;
  playerName = document.getElementById("playerName").value.trim();
  avatar = document.getElementById("avatarSelect").value;
  if (!gameCode || !playerName) return alert("Enter game code and name");

  const playersRef = db.ref(`games/${gameCode}/players`);
  playersRef.once("value").then(snap => {
    const players = snap.val() || {};
    if (Object.keys(players).length >= 4) return alert("Game full");
    playerId = `player${Object.keys(players).length + 1}`;
    db.ref(`games/${gameCode}/players/${playerId}`).set({ name: playerName, avatar, hand: [], score: 0 });
    db.ref(`games/${gameCode}/players/${playerId}`).onDisconnect().remove();

    db.ref(`games/${gameCode}/status`).once("value").then(statusSnap => {
      const status = statusSnap.val();
      document.getElementById("controls").style.display = status === "started" ? "flex" : "none";
      document.getElementById("chatBox").style.display = status === "started" ? "block" : "none";
      document.getElementById("lobby").style.display = "none";
      document.getElementById("game").style.display = "block";
      if (playerId === "player1") document.getElementById("startBtn").style.display = "inline-block";
      listen();
    });
  });
}

function listen() {
  const g = `games/${gameCode}`;
  db.ref(`${g}/status`).on("value", s => {
    const status = s.val();
    document.getElementById("controls").style.display = status === "started" ? "flex" : "none";
    document.getElementById("chatBox").style.display = status === "started" ? "block" : "none";
    document.getElementById("startBtn").style.display = "none";
    if (playerId === "player1") document.getElementById("resetBtn").style.display = "inline-block";
  });
  db.ref(`${g}/players`).on("value", snap => {
    const players = snap.val() || {};
    const others = Object.entries(players).filter(([id]) => id !== playerId);
    document.getElementById("opponentArea").innerHTML = others.map(([_, p]) => `<div><div>${p.name}</div><img src='https://api.dicebear.com/7.x/thumbs/svg?seed=${p.avatar}'/><div>${"üÇ† ".repeat(13)}</div></div>`).join("");
    document.getElementById("yourAvatar").innerHTML = `<div>${playerName}</div><img src='https://api.dicebear.com/7.x/thumbs/svg?seed=${avatar}'/>`;
  });
  db.ref(`${g}/turn`).on("value", s => {
    const turn = s.val();
    db.ref(`${g}/players/${turn}`).once("value").then(p => {
      const name = p.val() ? p.val().name : "someone";
      document.getElementById("turnInfo").innerText = turn === playerId ? "Your Turn!" : `${name}'s Turn`;
    });
  });
  db.ref(`${g}/players/${playerId}/hand`).on("value", s => {
    const hand = s.val() || [];
    const div = document.getElementById("hand");
    div.innerHTML = "";
    hand.forEach((c, i) => {
      const img = document.createElement("img");
      img.className = "card-img";
      img.src = getCardImage(c);
      img.onclick = () => discard(i);
      div.appendChild(img);
    });
  });
  db.ref(`${g}/deck`).on("value", s => document.getElementById("deckSize").innerText = (s.val() || []).length);
  db.ref(`${g}/discard`).on("value", s => document.getElementById("topDiscard").innerText = s.val() || "None");
  db.ref(`${g}/chat`).on("child_added", snap => {
    const msg = snap.val();
    const bubble = document.createElement("div");
    bubble.className = "chat-bubble";
    bubble.innerText = `${msg.name}: ${msg.text}`;
    document.getElementById("chatArea").appendChild(bubble);
  });
}

function startGame() {
  const suits = ['Spades', 'Hearts', 'Diamonds', 'Clubs'];
  const ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  const g = `games/${gameCode}`;
  db.ref(`${g}/players`).once("value").then(snap => {
    const players = snap.val();
    let deck = [];
    for (let i = 0; i < 2; i++) suits.forEach(s => ranks.forEach(r => deck.push(`${r} of ${s}`)));
    deck = deck.sort(() => Math.random() - 0.5);
    db.ref(`${g}/deck`).set(deck);
    db.ref(`${g}/status`).set("started");
    db.ref(`${g}/discard`).set("None");
    Object.keys(players).forEach(pid => {
      const hand = deck.splice(0, 13);
      db.ref(`${g}/players/${pid}/hand`).set(hand);
    });
    db.ref(`${g}/deck`).set(deck);
    db.ref(`${g}/turn`).set("player1");
  });
}

function drawCard() {
  const g = `games/${gameCode}`;
  db.ref(`${g}/turn`).once("value").then(t => {
    if (t.val() !== playerId) return alert("Not your turn!");
    if (hasDrawn) return alert("Already drew a card.");
    db.ref(`${g}/deck`).once("value").then(s => {
      const deck = s.val();
      const card = deck.pop();
      db.ref(`${g}/deck`).set(deck);
      db.ref(`${g}/players/${playerId}/hand`).once("value").then(h => {
        const hand = h.val() || [];
        hand.push(card);
        db.ref(`${g}/players/${playerId}/hand`).set(hand);
        hasDrawn = true;
      });
    });
  });
}

function discard(index) {
  if (!hasDrawn) return alert("Draw a card first!");
  const g = `games/${gameCode}`;
  db.ref(`${g}/players/${playerId}/hand`).once("value").then(h => {
    const hand = h.val();
    const card = hand.splice(index, 1)[0];
    db.ref(`${g}/players/${playerId}/hand`).set(hand);
    db.ref(`${g}/discard`).set(card);
    db.ref(`${g}/players`).once("value").then(snap => {
      const ids = Object.keys(snap.val());
      const i = ids.indexOf(playerId);
      const next = ids[(i + 1) % ids.length];
      db.ref(`${g}/turn`).set(next);
      hasDrawn = false;
    });
  });
}

function sortHand() {
  const g = `games/${gameCode}`;
  db.ref(`${g}/players/${playerId}/hand`).once("value").then(h => {
    const hand = h.val();
    hand.sort();
    db.ref(`${g}/players/${playerId}/hand`).set(hand);
  });
}

function meld() {
  const g = `games/${gameCode}`;
  db.ref(`${g}/players/${playerId}/hand`).once("value").then(snap => {
    const hand = snap.val() || [];
    const sets = {};
    const runs = {};
    hand.forEach(c => {
      const [r,,s] = c.split(" ");
      if (!sets[r]) sets[r] = [];
      sets[r].push(s);
      const key = s;
      if (!runs[key]) runs[key] = [];
      runs[key].push(r);
    });
    const isSet = Object.values(sets).some(arr => arr.length >= 3);
    const rankOrder = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    const isRun = Object.values(runs).some(arr => {
      const idxs = arr.map(r => rankOrder.indexOf(r)).sort((a,b)=>a-b);
      let seq = 1;
      for (let i = 1; i < idxs.length; i++) {
        if (idxs[i] === idxs[i-1] + 1) seq++;
        else seq = 1;
        if (seq >= 3) return true;
      }
      return false;
    });
    if (isSet || isRun) {
      alert("‚úÖ Valid meld. You declared!");
      db.ref(`${g}/status`).set("ended");
      db.ref(`${g}/winner`).set({ name: playerName, score: 100 });
    } else {
      alert("‚ùå Invalid meld. Try again.");
    }
  });
}

function resetGame() {
  if (confirm("Reset the game for everyone?")) {
    db.ref(`games/${gameCode}`).remove();
    location.reload();
  }
}

function sendChat() {
  const text = document.getElementById("chatInput").value;
  if (!text) return;
  db.ref(`games/${gameCode}/chat`).push({ name: playerName, text });
  document.getElementById("chatInput").value = "";
}

function sendQuick(text) {
  db.ref(`games/${gameCode}/chat`).push({ name: playerName, text });
}

function getCardImage(card) {
  const rankMap = { A: "A", J: "J", Q: "Q", K: "K", "10": "0" };
  const suitMap = { Spades: "S", Hearts: "H", Diamonds: "D", Clubs: "C" };
  const [rank, , suit] = card.split(" ");
  const r = rankMap[rank] || rank;
  const s = suitMap[suit];
  return `https://deckofcardsapi.com/static/img/${r}${s}.png`;
}
</script>
</body>
</html>
