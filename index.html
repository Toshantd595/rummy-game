<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Love Rummy</title>
  <meta name="description" content="Multiplayer Rummy Game with Love Theme" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    Babel.registerPreset("react", {
      presets: [Babel.availablePresets["react"]],
    });
  </script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            rose: { 500: "#f43f5e", 700: "#be123c" },
            pink: { 500: "#ec4899", 600: "#db2777" },
          },
        },
      },
    };
  </script>

  <style>
    body {
      background: linear-gradient(to bottom right, #fdf2f8, #fce7f3, #fbcfe8);
      font-family: 'Segoe UI', sans-serif;
    }
    .love-gradient {
      background: linear-gradient(to right, #f472b6, #fb7185, #f472b6);
    }
    .card {
      width: 40px;
      height: 60px;
      border-radius: 6px;
      text-align: center;
      padding-top: 12px;
      font-size: 18px;
      font-weight: bold;
      background-color: white;
      border: 2px solid #fb7185;
      margin: 2px;
      box-shadow: 1px 1px 4px rgba(0,0,0,0.2);
    }
    .selected {
      transform: translateY(-10px);
      border-color: #db2777;
    }
    .red-suit {
      color: #e11d48;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-presets="react">
    const { useState, useEffect } = React;

    const firebaseConfig = {
      apiKey: "AIzaSyC1D45vfziD-wqIrDGANAY7GzR0L94BqB8",
      authDomain: "rummy-multiplayer-fe391.firebaseapp.com",
      databaseURL: "https://rummy-multiplayer-fe391-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "rummy-multiplayer-fe391",
      storageBucket: "rummy-multiplayer-fe391.appspot.com",
      messagingSenderId: "717212591323",
      appId: "1:717212591323:web:7cb38b16733f7a9b5498fe"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function App() {
      const [room, setRoom] = useState(null);
      const [playerId, setPlayerId] = useState(null);
      const [players, setPlayers] = useState([]);
      const [hand, setHand] = useState([]);
      const [turn, setTurn] = useState(null);
      const [winner, setWinner] = useState(null);
      const [selected, setSelected] = useState([]);
      const [message, setMessage] = useState("");

      useEffect(() => {
        const hash = window.location.hash.slice(1);
        if (!hash) return;
        setRoom(hash);
        const id = Math.random().toString(36).substr(2, 6);
        setPlayerId(id);

        const playerRef = db.ref(`rooms/${hash}/players/${id}`);
        playerRef.set(true);
        playerRef.onDisconnect().remove();

        db.ref(`rooms/${hash}/players`).on("value", (snap) => {
          if (snap.exists()) {
            setPlayers(Object.keys(snap.val()));
          }
        });

        db.ref(`rooms/${hash}/hands/${id}`).on("value", (snap) => {
          if (snap.exists()) setHand(snap.val());
        });

        db.ref(`rooms/${hash}/turn`).on("value", (snap) => {
          if (snap.exists()) setTurn(snap.val());
        });

        db.ref(`rooms/${hash}/winner`).on("value", (snap) => {
          if (snap.exists()) setWinner(snap.val());
        });
      }, []);

      const drawCard = async () => {
        if (turn !== playerId) return;
        const deckSnap = await db.ref(`rooms/${room}/deck`).get();
        const deck = deckSnap.val() || [];
        if (deck.length === 0) return;
        const drawn = deck.pop();
        await db.ref(`rooms/${room}/deck`).set(deck);
        const newHand = [...hand, drawn];
        await db.ref(`rooms/${room}/hands/${playerId}`).set(newHand);
      };

      const discardCard = async () => {
        if (turn !== playerId || selected.length !== 1) return;
        const card = selected[0];
        const newHand = hand.filter(c => c !== card);
        await db.ref(`rooms/${room}/hands/${playerId}`).set(newHand);
        await db.ref(`rooms/${room}/discard`).set(card);
        const nextPlayer = players.find(p => p !== playerId);
        await db.ref(`rooms/${room}/turn`).set(nextPlayer);
        setSelected([]);
      };

      const createRoom = async () => {
        const newRoom = Math.random().toString(36).substr(2, 6).toUpperCase();
        const deck = shuffleDeck();
        const p1 = Math.random().toString(36).substr(2, 6);
        const p2 = Math.random().toString(36).substr(2, 6);
        const hands = {
          [p1]: deck.slice(0, 13),
          [p2]: deck.slice(13, 26),
        };
        await db.ref(`rooms/${newRoom}`).set({
          deck: deck.slice(26),
          hands,
          players: {[p1]: true, [p2]: true},
          turn: p1,
        });
        window.location.hash = newRoom;
        window.location.reload();
      };

      const shuffleDeck = () => {
        const suits = ["â™ ", "â™¥", "â™¦", "â™£"];
        const values = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];
        let deck = [];
        suits.forEach(suit => values.forEach(value => deck.push(value + suit)));
        return deck.sort(() => Math.random() - 0.5);
      };

      return (
        <div className="p-4 text-center">
          <h1 className="text-3xl font-bold love-gradient text-transparent bg-clip-text mb-4">ðŸ’– Love Rummy</h1>
          {!room && (
            <>
              <button onClick={createRoom} className="bg-pink-500 text-white px-6 py-3 rounded-lg shadow m-2">Create Room</button>
              <button onClick={() => {
                const joinCode = prompt("Enter Room Code");
                if (joinCode) {
                  window.location.hash = joinCode.toUpperCase();
                  window.location.reload();
                }
              }} className="bg-rose-500 text-white px-6 py-3 rounded-lg shadow m-2">Join Room</button>
            </>
          )}

          {room && (
            <>
              <h2 className="text-lg text-pink-700">Room: {room}</h2>
              {winner ? <h3 className="text-green-600 font-semibold mt-2">ðŸŽ‰ {winner} wins!</h3> : <h3 className="mb-2 text-rose-500">{turn === playerId ? "ðŸŽ¯ Your Turn" : "Waiting..."}</h3>}

              <div className="flex flex-wrap justify-center mb-4">
                {hand.map(card => (
                  <div key={card} onClick={() => setSelected(prev => prev.includes(card) ? prev.filter(c => c !== card) : [...prev, card])} className={`card ${selected.includes(card) ? "selected" : ""} ${(card.includes("â™¥") || card.includes("â™¦")) ? "red-suit" : ""}`}>{card}</div>
                ))}
              </div>

              {!winner && (
                <div className="flex flex-wrap justify-center gap-2">
                  <button onClick={drawCard} className="bg-purple-500 text-white px-4 py-2 rounded">Draw</button>
                  <button onClick={discardCard} className="bg-rose-500 text-white px-4 py-2 rounded">Discard</button>
                </div>
              )}
              <p className="mt-4 text-pink-600">{message}</p>
            </>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
