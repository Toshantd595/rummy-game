<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Love Rummy</title>
  <meta name="description" content="Multiplayer Rummy Game with Love Theme" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>
    Babel.registerPreset("react", {
      presets: [Babel.availablePresets["react"]],
    });
  </script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            rose: { 500: "#f43f5e", 700: "#be123c" },
            pink: { 500: "#ec4899", 600: "#db2777" },
          },
        },
      },
    };
  </script>

  <style>
    body {
      background: linear-gradient(to bottom right, #fdf2f8, #fce7f3, #fbcfe8);
      font-family: 'Segoe UI', sans-serif;
    }
    .card {
      width: 50px;
      height: 70px;
      border-radius: 6px;
      background: white;
      border: 2px solid #fb7185;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 4px;
      box-shadow: 1px 1px 5px rgba(0,0,0,0.1);
      cursor: pointer;
    }
    .selected {
      transform: translateY(-10px);
      border-color: #db2777;
    }
    .card-back {
      width: 50px;
      height: 70px;
      border-radius: 6px;
      background: repeating-linear-gradient(
        45deg,
        #fb7185,
        #fb7185 5px,
        #fbcfe8 5px,
        #fbcfe8 10px
      );
      border: 2px solid #be123c;
      margin: 4px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="react">
    const { useState, useEffect } = React;

    const firebaseConfig = {
      apiKey: "AIzaSyC1D45vfziD-wqIrDGANAY7GzR0L94BqB8",
      authDomain: "rummy-multiplayer-fe391.firebaseapp.com",
      databaseURL: "https://rummy-multiplayer-fe391-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "rummy-multiplayer-fe391",
      storageBucket: "rummy-multiplayer-fe391.appspot.com",
      messagingSenderId: "717212591323",
      appId: "1:717212591323:web:7cb38b16733f7a9b5498fe"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function generateDeck() {
      const suits = ["â™ ", "â™¥", "â™¦", "â™£"];
      const values = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];
      const deck = [];
      for (let suit of suits) {
        for (let value of values) {
          deck.push(value + suit);
        }
      }
      return deck.sort(() => Math.random() - 0.5);
    }

    function App() {
      const [room, setRoom] = useState(null);
      const [playerId, setPlayerId] = useState(null);
      const [players, setPlayers] = useState([]);
      const [hand, setHand] = useState([]);
      const [selected, setSelected] = useState([]);
      const [turn, setTurn] = useState(null);
      const [deck, setDeck] = useState([]);
      const [opponentCards, setOpponentCards] = useState(0);
      const [hasDrawn, setHasDrawn] = useState(false);
      const [message, setMessage] = useState("");
      const [roomInput, setRoomInput] = useState("");

      const joinRoom = (code) => {
        const id = Math.random().toString(36).slice(2, 7);
        setPlayerId(id);
        setRoom(code);

        const roomRef = db.ref(`rooms/${code}`);
        roomRef.once("value", snap => {
          const data = snap.val();
          const updatedPlayers = data?.players || [];
          if (!updatedPlayers.includes(id)) {
            db.ref(`rooms/${code}/players`).set([...updatedPlayers, id]);
          }
          setPlayers([...updatedPlayers, id]);
        });

        db.ref(`rooms/${code}/hands/${id}`).on("value", snap => {
          if (snap.exists()) setHand(snap.val());
        });
        db.ref(`rooms/${code}/turn`).on("value", snap => {
          if (snap.exists()) setTurn(snap.val());
        });
        db.ref(`rooms/${code}/deck`).on("value", snap => {
          if (snap.exists()) setDeck(snap.val());
        });
      };

      const createRoom = () => {
        const newCode = Math.random().toString(36).substr(2, 6).toUpperCase();
        joinRoom(newCode);
        const fullDeck = generateDeck();
        const p1 = playerId || Math.random().toString(36).slice(2, 7);
        const p2 = Math.random().toString(36).slice(2, 7);
        const initial = {
          players: [p1],
          deck: fullDeck.slice(26),
          hands: {
            [p1]: fullDeck.slice(0, 13),
          },
          turn: p1,
          discard: null,
        };
        db.ref(`rooms/${newCode}`).set(initial);
        window.location.hash = newCode;
      };

      const drawCard = () => {
        if (turn !== playerId || hasDrawn) return;
        const topCard = deck.pop();
        db.ref(`rooms/${room}/hands/${playerId}`).set([...hand, topCard]);
        db.ref(`rooms/${room}/deck`).set(deck);
        setHasDrawn(true);
      };

      const discardCard = (card) => {
        if (turn !== playerId || !hasDrawn) return;
        const newHand = hand.filter(c => c !== card);
        db.ref(`rooms/${room}/hands/${playerId}`).set(newHand);
        const nextPlayer = players.find(p => p !== playerId);
        db.ref(`rooms/${room}/turn`).set(nextPlayer);
        setHasDrawn(false);
        setSelected([]);
      };

      useEffect(() => {
        if (!room) return;
        db.ref(`rooms/${room}/players`).on("value", snap => {
          const arr = snap.val() || [];
          setPlayers(arr);
          const opp = arr.find(p => p !== playerId);
          if (opp) {
            db.ref(`rooms/${room}/hands/${opp}`).on("value", snap => {
              setOpponentCards(snap.val()?.length || 0);
            });
          }
        });
      }, [room]);

      return (
        <div className="p-4 text-center">
          <h1 className="text-3xl font-bold text-rose-600 mb-4">ðŸ’– Love Rummy</h1>

          {!room && (
            <div className="space-y-4">
              <button onClick={createRoom} className="px-6 py-3 bg-pink-500 text-white rounded-lg shadow">
                Create Room
              </button>
              <div className="flex justify-center gap-2">
                <input
                  value={roomInput}
                  onChange={e => setRoomInput(e.target.value)}
                  className="border px-4 py-2 rounded"
                  placeholder="Enter Room Code"
                />
                <button
                  onClick={() => joinRoom(roomInput)}
                  className="bg-green-500 text-white px-4 py-2 rounded"
                >
                  Join
                </button>
              </div>
            </div>
          )}

          {room && (
            <>
              <h2 className="text-lg text-pink-700 mb-1">Room: {room}</h2>
              <p className="text-sm text-gray-600 mb-2">
                {turn === playerId ? "ðŸŽ¯ Your Turn" : "Waiting..."}
              </p>

              <div className="flex justify-center mb-2">
                {[...Array(opponentCards)].map((_, i) => (
                  <div key={i} className="card-back"></div>
                ))}
              </div>

              <div className="flex flex-wrap justify-center mb-4">
                {hand.map((card, idx) => (
                  <div
                    key={idx}
                    className={`card ${selected.includes(card) ? "selected" : ""}`}
                    onClick={() =>
                      setSelected(prev =>
                        prev.includes(card)
                          ? prev.filter(c => c !== card)
                          : [...prev, card]
                      )
                    }
                  >
                    {card}
                  </div>
                ))}
              </div>

              <div className="flex justify-center gap-2">
                <button onClick={drawCard} className="bg-purple-500 text-white px-4 py-2 rounded">
                  Draw
                </button>
                <button
                  onClick={() => selected[0] && discardCard(selected[0])}
                  className="bg-rose-500 text-white px-4 py-2 rounded"
                >
                  Discard
                </button>
              </div>

              <p className="mt-4 text-pink-600">{message}</p>
            </>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
