<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Love Rummy - Final</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to bottom, #fff0f5, #ffe4e1);
      margin: 0;
      padding: 0;
      color: #333;
    }
    .container { max-width: 1000px; margin: auto; padding: 20px; text-align: center; }
    .header h1 { color: #e91e63; }
    .control-btn, .fun-chat-btn {
      background-color: #ff4081;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      cursor: pointer;
      transition: transform 0.2s ease;
      margin: 5px;
    }
    .control-btn:hover, .fun-chat-btn:hover { transform: scale(1.05); }
    .card {
      width: 60px; height: 90px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      display: inline-block;
      margin: 5px;
      padding-top: 25px;
      transition: transform 0.3s ease;
      cursor: pointer;
    }
    .card:hover {
      transform: rotate(-2deg) scale(1.1);
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    #playerHand { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 10px; }
    #chatMessages {
      height: 150px; overflow-y: auto;
      border: 1px solid #ddd;
      margin-bottom: 10px;
      background: #fff5f8; padding: 10px;
      border-radius: 8px;
    }
    .chat-message { margin: 5px 0; }
    .hidden { display: none; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üíñ Love Rummy üíñ</h1>
    <p>Multiplayer romance. Real Rummy rules.</p>
  </div>

  <div>
    <button class="control-btn" onclick="createRoom()">Create Room</button>
    <button class="control-btn" onclick="joinRoom()">Join Room</button>
    <div id="roomDisplay"></div>
  </div>

  <div id="gameUI" class="hidden">
    <div id="playerList"></div>
    <div id="turnIndicator"></div>
    <button id="startGameBtn" class="control-btn hidden" onclick="startGame()">Start Game</button>
    <div id="playerHand"></div>
    <div id="discardPile"></div>
    <button class="control-btn" onclick="drawCard()">Draw</button>
    <button class="control-btn" onclick="declareWin()">Declare</button>
    <div id="chatMessages"></div>
    <input type="text" id="chatInput" placeholder="Say something...">
    <button onclick="sendMessage()">Send</button>
    <button class="fun-chat-btn" onclick="quickChat('Hi Queen of Hearts üíò')">Hi Queen of Hearts üíò</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyC1D45vfziD-wqIrDGANAY7GzR0L94BqB8",
  authDomain: "rummy-multiplayer-fe391.firebaseapp.com",
  databaseURL: "https://rummy-multiplayer-fe391-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "rummy-multiplayer-fe391",
  storageBucket: "rummy-multiplayer-fe391.appspot.com",
  messagingSenderId: "717212591323",
  appId: "1:717212591323:web:7cb38b16733f7a9b5498fe"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let roomId = '', playerId = '', username = '', hand = [], deck = [], discard = [], currentTurn = '', players = {}; 

function generateDeck() {
  const suits = ['‚ô•Ô∏è','‚ô£Ô∏è','‚ô¶Ô∏è','‚ô†Ô∏è'];
  const values = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  let full = [];
  suits.forEach(s => values.forEach(v => full.push(`${v}${s}`)));
  return full.sort(() => Math.random() - 0.5);
}

function createRoom() {
  username = prompt("Your name:");
  if (!username) return;
  roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
  playerId = `player_${Date.now()}`;
  
  db.ref(`rooms/${roomId}`).set({
    status: 'waiting',
    players: { [playerId]: username }
  }).then(() => {
    enterRoom(); // ‚úÖ only after Firebase has written data
  }).catch(err => {
    alert("Error creating room: " + err.message);
  });
}


function joinRoom() {
  username = prompt("Your name:");
  if (!username) return;
  roomId = prompt("Enter Room Code:");
  if (!roomId) return;
  playerId = `player_${Date.now()}`;
  
  db.ref(`rooms/${roomId}/players/${playerId}`).set(username).then(() => {
    enterRoom(); // ‚úÖ wait until player is added before setting up listeners
  }).catch(err => {
    alert("Invalid room code or failed to join: " + err.message);
  });
}


function enterRoom() {
  document.getElementById('roomDisplay').innerText = `Room: ${roomId}`;
  document.getElementById('gameUI').classList.remove('hidden');
  db.ref(`rooms/${roomId}/players`).on('value', snap => {
    players = snap.val() || {};
    const list = Object.values(players).map(name => `<div>${name}</div>`).join('');
    document.getElementById('playerList').innerHTML = list;
    if (Object.keys(players).length >= 2 && Object.keys(players)[0] === playerId) {
      document.getElementById('startGameBtn').classList.remove('hidden');
    }
  });
  db.ref(`rooms/${roomId}/chat`).on('child_added', snap => {
    const msg = snap.val();
    document.getElementById('chatMessages').innerHTML += `<div><strong>${msg.from}</strong>: ${msg.text}</div>`;
  });
  db.ref(`rooms/${roomId}/discard`).on('value', snap => {
    const top = snap.val();
    document.getElementById('discardPile').innerHTML = top ? `<div class='card'>${top}</div>` : '';
  });
  db.ref(`rooms/${roomId}/turn`).on('value', snap => {
    currentTurn = snap.val();
    document.getElementById('turnIndicator').innerText = (currentTurn === playerId) ? "Your turn" : `${players[currentTurn]}'s turn`;
  });
  db.ref(`rooms/${roomId}/hands/${playerId}`).on('value', snap => {
    hand = snap.val() || [];
    updateHand();
  });
}

function startGame() {
  deck = generateDeck();
  let hands = {};
  const ids = Object.keys(players);
  ids.forEach(pid => hands[pid] = deck.splice(0, 13));
  db.ref(`rooms/${roomId}`).update({
    deck,
    hands,
    discard: '',
    turn: ids[0],
    status: 'started'
  });
}

function drawCard() {
  if (playerId !== currentTurn) return alert("Not your turn!");
  db.ref(`rooms/${roomId}/deck`).once('value', snap => {
    const updatedDeck = snap.val();
    if (!updatedDeck || updatedDeck.length === 0) return alert("Deck is empty");
    const card = updatedDeck.shift();
    hand.push(card);
    db.ref(`rooms/${roomId}/deck`).set(updatedDeck);
    db.ref(`rooms/${roomId}/hands/${playerId}`).set(hand);
    updateHand();
  });
}

function updateHand() {
  const div = document.getElementById('playerHand');
  div.innerHTML = hand.map((c, i) => `<div class='card' onclick='discardCard(${i})'>${c}</div>`).join('');
}

function discardCard(index) {
  if (playerId !== currentTurn || hand.length !== 14) return alert("Draw first and discard exactly one.");
  const card = hand.splice(index, 1)[0];
  db.ref(`rooms/${roomId}/hands/${playerId}`).set(hand);
  db.ref(`rooms/${roomId}/discard`).set(card);
  const ids = Object.keys(players);
  const nextIndex = (ids.indexOf(currentTurn) + 1) % ids.length;
  db.ref(`rooms/${roomId}/turn`).set(ids[nextIndex]);
  updateHand();
}

function isValidMeld(cards) {
  // Helper: sort card values
  const order = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
  function cardValue(c) { return order.indexOf(c.slice(0, -1)); }
  function cardSuit(c) { return c.slice(-1); }
  function groupBy(arr, keyFn) {
    return arr.reduce((acc, card) => {
      const key = keyFn(card);
      acc[key] = acc[key] || [];
      acc[key].push(card);
      return acc;
    }, {});
  }

  // Step 1: Generate all 3-partitions of the 13 cards into [4,3,3,3]
  function generatePartitions(cards) {
    let results = [];
    const pick = (arr, count) => {
      if (count === 0) return [[]];
      if (!arr.length) return [];
      let res = [];
      for (let i = 0; i < arr.length; i++) {
        const head = arr[i];
        const tail = arr.slice(0, i).concat(arr.slice(i + 1));
        const smaller = pick(tail, count - 1);
        for (let s of smaller) res.push([head, ...s]);
      }
      return res;
    };

    const sets4 = pick(cards, 4);
    for (let set4 of sets4) {
      const rem1 = cards.filter(c => !set4.includes(c));
      const sets3a = pick(rem1, 3);
      for (let set3a of sets3a) {
        const rem2 = rem1.filter(c => !set3a.includes(c));
        const sets3b = pick(rem2, 3);
        for (let set3b of sets3b) {
          results.push([set4, set3a, set3b]);
        }
      }
    }
    return results;
  }

  function isValidSet(set) {
    if (set.length !== 3 && set.length !== 4) return false;
    const suits = set.map(cardSuit);
    const values = set.map(c => c.slice(0, -1));
    const allSameValue = new Set(values).size === 1;
    const sameSuit = new Set(suits).size === 1;
    const sorted = values.map(v => order.indexOf(v)).sort((a, b) => a - b);
    const isSequence = sorted.every((v, i, arr) => i === 0 || v === arr[i - 1] + 1);
    return allSameValue || (sameSuit && isSequence);
  }

  const sets = generatePartitions(cards);
  for (let [a, b, c] of sets) {
    if (isValidSet(a) && isValidSet(b) && isValidSet(c)) return true;
  }
  return false;
}

function declareWin() {
  if (hand.length !== 13) return alert(\"You must have exactly 13 cards to declare.\");

  if (isValidMeld(hand)) {
    alert(\"üéâ You WON! Valid Rummy meld formed!\");
  } else {
    alert(\"‚ùå Invalid meld. You need 3 valid groups of 4-3-3 by kind or sequence.\");
  }
}


function sendMessage() {
  const msg = document.getElementById('chatInput').value.trim();
  if (!msg) return;
  db.ref(`rooms/${roomId}/chat`).push({ from: username, text: msg });
  document.getElementById('chatInput').value = '';
}

function quickChat(message) {
  db.ref(`rooms/${roomId}/chat`).push({ from: username, text: message });
}
</script>
</body>
</html>
